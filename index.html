<!DOCTYPE html>
<html lang="en">
    <head>
        <script type="text/javascript" src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
        <script type="text/javascript" src="https://unpkg.com/web3@0.20.5/dist/web3.min.js"></script>
        <!-- The generated javascript and app.js will be substituted in below -->
        
<script type="text/javascript">
/* Autogenerated - do not fiddle */
            if(typeof(Contracts)==="undefined") var Contracts={};
            (function(module, Contracts) {
                var data={
                    address: "0x63000efb503dcf86059d4ebfa59cf32cd556c232",
                    network: "ropsten",
                    endpoint: "https://ropsten.infura.io/",
                    abi: [
    {
        "constant": true,
        "inputs": [],
        "name": "numArticles",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "owner",
        "outputs": [
            {
                "name": "",
                "type": "address"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "author",
        "outputs": [
            {
                "name": "",
                "type": "address"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "index",
                "type": "uint256"
            }
        ],
        "name": "getArticle",
        "outputs": [
            {
                "name": "",
                "type": "string"
            },
            {
                "name": "",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "title",
                "type": "string"
            },
            {
                "name": "hash",
                "type": "string"
            }
        ],
        "name": "publish",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "name": "givenAuthor",
                "type": "address"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "constructor"
    }
]
            };
            Contracts["NewsFeed"]=data;
            module.exports=data;
            })((typeof(module)==="undefined"?{}:module), Contracts);
            
// The object 'Contracts' will be injected here, which contains all data for all contracts, keyed on contract name:
// Contracts['NewsFeed'] = {
//  abi: [],
//  address: "0x..",
//  endpoint: "http://...."
// }
function Articles(Contract) {
    this.web3 = null;
    this.instance = null;
    this.Contract = Contract;
}

Articles.prototype.getNumArticles = function(cb) {
    this.instance.numArticles(function (error, result) {
        cb(error, result);
    });
}

Articles.prototype.getArticle = function(index, cb) {
    this.instance.getArticle(index, function (error, result) {
        cb(error, result);
    });
}

Articles.prototype.init = function() {
    // We create a new Web3 instance using either the Metamask provider
    // or an independent provider created towards the endpoint configured for the contract.
    this.web3 = new Web3(
        (window.web3 && window.web3.currentProvider) ||
        new Web3.providers.HttpProvider(this.Contract.endpoint));

    // Create the contract interface using the ABI provided in the configuration.
    var contract_interface = this.web3.eth.contract(this.Contract.abi);

    // Create the contract instance for the specific address provided in the configuration.
    this.instance = contract_interface.at(this.Contract.address);
};

Articles.prototype.renderArticle = function(index) {
    var that = this;
    if (index < 0) {
        return;
    }
    this.getArticle(index, function (error, result) {
        if (error) {
            console.error("Could not load article:", error);
            $('#articles').append(
                "<h3>Could not load article.</h3>"
            );
            return;
        }
        else {
            var data = `
                <div class='article'><h3>` + result[0] + `</h3>
                <a target='_blank' href='` + result[1] + `'>` + result[1] + `</a></div>
            `;
            $('#articles').append(data);
        }
        that.renderArticle(index - 1);
    });
}

Articles.prototype.main = function() {
    var that = this;
    this.getNumArticles(function (error, result) {
        if (error) {
            console.error(error);
            $(".error").show();
            return;
        }
        var nrArticles = result.toNumber();
        
        if (nrArticles == 0) {
            $('#articles').append(
                "<h3>No articles here yet.. Try reloading in a while.</h3>"
            );
        }
        else {
            that.renderArticle(nrArticles - 1);
        }
    });
}

Articles.prototype.onReady = function() {
    this.init();
    this.main();
};

var articles = new Articles(Contracts['NewsFeed']);

$(document).ready(function() {
    articles.onReady();
});

</script>



        <!-- The app.css contents will be substituted in below -->
        <style type="text/css">
body {
    background-color: darkred;
    font-size: 1.3em;
    text-align: center;
    color: antiquewhite;
}

h3 {
    font-size: 1.6em;
}

.error {
    display: none;
}

div.article {
    margin: 10px;
    padding: 20px;
    display: block;
    background-color: black;
}

div.article a {
    color: darkgoldenrod;
}
</style>

    </head>
    <body>
        <h1>YOUR CENSORSHIP RESISTANT NEWSFEED</h1>
        <h2 class="error">There was an error communicating with the contract.</h2>
        <div id="articles"></div>
    </body>
</html>